
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>4.10 Time Series Forecast &#8212; ML Geo Curriculum</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deep Learning Exploration with AI-Ready Datasets" href="mlgeo_4.20_final_project_assignement.html" />
    <link rel="prev" title="4.9 LLMGEO" href="mlgeo_4.9_LLM4Geo.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/GeoSMART_logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">ML Geo Curriculum</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../about_this_book/about_this_book.html">
                    Machine Learning in the Geosciences
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About this Book
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://geo-smart.github.io/index.html">
   Geosmart website
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about_this_book/0_mlgeo_project.html">
   ML Project Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about_this_book/acknowledgements.html">
   Acknowlegments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 1 - Open Source Ecosystem
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/readme.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.1_open_reproducible_science.html">
   1.1 Open Reproducible Science
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.2_jupyter_environment.html">
   1.3 Jupyter Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.3_python_environment.html">
   1.3 Python Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.4_computational_environments.html">
   1.4 Computing Environments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.5_version_control_git.html">
   1.5 Version Control &amp; GitHub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.6_data_gallery.html">
   1.6 Data Gallery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter1-GettingStarted/1.20_MLGEO_Final_Project.html">
   Final Integrated Project in Machine Learning in Geoscience
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 2 - Data Manipulation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/readme.html">
   Chapter Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.1_Data_Definitions.html">
   2.1 Data Definitions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.2_data_formats_rendered.html">
   2.2 Data Formats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.3_pandas_rendered.html">
   2.3 Pandas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.4_dataframes_prep.html">
   2.4 DataFrame Exploration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.5_Arrays.html">
   2.5 Data Arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.6_resampling.html">
   2.6 Resampling Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.7_statistical_considerations.html">
   2.7 Statistical Considerations for geoscientific Data and Noise
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.8_data_spectral_transforms.html">
   2.8 Spectral Transforms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.9_filtering_data.html">
   2.9 Filtering Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.10_synthetic_noise.html">
   2.10 Synthetic noise
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.11_feature_engineering.html">
   2.11 Feature Engineering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.12_dimensionality_reduction.html">
   2.12 Dimensionality Reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.13_MLready_data.html">
   2.13 ML-ready data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter2-DataManipulation/2.20_Final_Project_Assignement.html">
   Assignment:
   <strong>
    Preparing AI-Ready Data for The Final Project
   </strong>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 3 - Machine Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/readme.html">
   Chapter Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.1_concepts_supervision.html">
   3.1 Concepts in training supervision
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.2_classification_regression.html">
   3.2 Classification and Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.3_clustering.html">
   3.3 Clustering: Unsupervised Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.4_binary_classification.html">
   3.4 Binary classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.5_multiclass_classification.html">
   3.5 Multiclass Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.6_logistic_regression.html">
   3.6 Logistic regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.7_randomForest_regression.html">
   3.7 Random Forests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.8_robust_training.html">
   3.8 Robust Training
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.9_ensemble_learning.html">
   3.9 Ensemble learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.10_autoML.html">
   3.10 AutoML
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/3.20_final_project_cml.html">
   <strong>
    Final Project - Classic Machine Learning
   </strong>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter3-MachineLearning/Homework_CML.html">
   Homework Classic Machine Learning (50 points)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 4 - Deep Learning
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="readme.html">
   Chapter Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.0_perceptrons.html">
   4.0 The Perceptron
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.1_NN.html">
   4.1 Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.2_MLP.html">
   4.2 Multi Layer Perceptrons
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.3_CNN.html">
   4.3 Convolutional Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.4_RNN.html">
   4.4  Recurrent Neural Networks: Processing sequences
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.5_ModelTraining.html">
   4.5 Model Training
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.6_AutoEncoder.html">
   4.6 Auto-encoders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.7_PINN.html">
   4.7 Physics-Informed Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.8_NAS.html">
   4.8 NAS: Network Architecture Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.9_LLM4Geo.html">
   4.9 LLMGEO
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   4.10 Time Series Forecast
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mlgeo_4.20_final_project_assignement.html">
   <strong>
    Deep Learning Exploration with AI-Ready Datasets
   </strong>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 5 - Workflow Management and Reproducibility
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter5-ModelWorkflows/readme.html">
   ML reproducibility
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 6- Introduction to Cloud Computing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/cloudmaven">
   Browser Access to Cloud Instances
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/Denolle-Lab/azure">
   Terraform Access to Cloud Instances
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://seisscoped.org/HPS-book/chapters/cloud/Introduction.html">
   AWS Cloud
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapter 7 - MLLGEO Projects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter7-UseCases/readme.html">
   Use Cases in MLGEO
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../reference/glossary.html">
   Glossaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../reference/bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/geo-smart/mlgeo-book/main?urlpath=lab/tree/book/Chapter4-DeepLearning/mlgeo_4.10_timeseriesforecast.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/geo-smart/mlgeo-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/geo-smart/mlgeo-book/issues/new?title=Issue%20on%20page%20%2FChapter4-DeepLearning/mlgeo_4.10_timeseriesforecast.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/geo-smart/mlgeo-book/edit/main/book/Chapter4-DeepLearning/mlgeo_4.10_timeseriesforecast.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Chapter4-DeepLearning/mlgeo_4.10_timeseriesforecast.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction-the-importance-of-time-series-forecasting-in-geoscientific-research">
   1. Introduction: The Importance of Time Series Forecasting in Geoscientific Research
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#important-concepts-in-time-series-forecasting">
   2. Important Concepts in Time series forecasting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#toy-dataset">
   3. Toy Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecasting-methods">
   3. Forecasting Methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#baseline-statistical-forecasts">
     3.1 Baseline: Statistical Forecasts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classic-machine-learning">
     3.2. Classic Machine Learning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deep-learning">
     3.3 Deep Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison-and-discussion">
   4. Comparison and Discussion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-foundation-models">
   5. Testing Foundation Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#earthquake-data">
     5.1 Earthquake Data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#reshape-for-prediction">
       Reshape for Prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#predict-with-chronos-plot">
       Predict with Chronos &amp; Plot
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#icesheet-velocities">
     5.2 Icesheet velocities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Reshape for prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#predict-plot-forecasts-with-chronos">
       Predict &amp; Plot forecasts with Chronos
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecasting-gps-velocities">
     5.3 Forecasting GPS velocities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#horizontal-components">
       Horizontal components
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecast-dv-v">
     5.4 Forecast dv/v
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#soil-moisture">
     5.5 Soil moisture
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#seismic-wave">
       5.6 Seismic Wave
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#co2">
       5.7 CO2
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#paleo-climate-benthic-d018-time-series">
       5.8 Paleo Climate Benthic D018 time series
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>4.10 Time Series Forecast</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction-the-importance-of-time-series-forecasting-in-geoscientific-research">
   1. Introduction: The Importance of Time Series Forecasting in Geoscientific Research
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#important-concepts-in-time-series-forecasting">
   2. Important Concepts in Time series forecasting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#toy-dataset">
   3. Toy Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecasting-methods">
   3. Forecasting Methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#baseline-statistical-forecasts">
     3.1 Baseline: Statistical Forecasts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classic-machine-learning">
     3.2. Classic Machine Learning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deep-learning">
     3.3 Deep Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison-and-discussion">
   4. Comparison and Discussion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-foundation-models">
   5. Testing Foundation Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#earthquake-data">
     5.1 Earthquake Data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#reshape-for-prediction">
       Reshape for Prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#predict-with-chronos-plot">
       Predict with Chronos &amp; Plot
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#icesheet-velocities">
     5.2 Icesheet velocities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Reshape for prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#predict-plot-forecasts-with-chronos">
       Predict &amp; Plot forecasts with Chronos
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecasting-gps-velocities">
     5.3 Forecasting GPS velocities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#horizontal-components">
       Horizontal components
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#forecast-dv-v">
     5.4 Forecast dv/v
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#soil-moisture">
     5.5 Soil moisture
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#seismic-wave">
       5.6 Seismic Wave
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#co2">
       5.7 CO2
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#paleo-climate-benthic-d018-time-series">
       5.8 Paleo Climate Benthic D018 time series
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="time-series-forecast">
<h1>4.10 Time Series Forecast<a class="headerlink" href="#time-series-forecast" title="Permalink to this headline">#</a></h1>
<section id="introduction-the-importance-of-time-series-forecasting-in-geoscientific-research">
<h2>1. Introduction: The Importance of Time Series Forecasting in Geoscientific Research<a class="headerlink" href="#introduction-the-importance-of-time-series-forecasting-in-geoscientific-research" title="Permalink to this headline">#</a></h2>
<p>Time series forecasting has been a cornerstone of geoscientific research, providing essential insights into Earth system processes and enabling proactive decision-making in diverse applications. From predicting <strong>seasonal climate patterns</strong> and <strong>river discharge</strong> to monitoring <strong>seismic activity</strong> and <strong>volcanic eruptions</strong>, time series analysis offers a powerful framework to understand temporal trends, cycles, and anomalies in geophysical data.</p>
<p><strong>Why Time Series Forecasting Matters in Geosciences</strong></p>
<ol class="simple">
<li><p><strong>Climate and Weather Forecasting</strong>:<br />
Seasonal and interannual climate variations, such as the El Niño-Southern Oscillation (ENSO), have profound impacts on agriculture, water resources, and disaster preparedness. Accurate forecasting helps manage risks associated with droughts, floods, and heatwaves.</p></li>
<li><p><strong>Hydrology and Water Resource Management</strong>:<br />
Streamflow and reservoir inflow forecasting are critical for managing water supplies, especially in regions prone to water scarcity or flooding.</p></li>
<li><p><strong>Seismic and Volcanic Monitoring</strong>:<br />
While precise prediction of earthquakes remains elusive, forecasting the likelihood of seismic events based on past activity patterns can guide hazard mitigation strategies. Similarly, time series data from volcanic monitoring systems provide early warning for eruptions.</p></li>
<li><p><strong>Oceanography and Marine Ecosystems</strong>:<br />
Forecasting changes in sea surface temperatures and ocean currents informs fisheries management and helps monitor phenomena like coral bleaching and ocean acidification.</p></li>
<li><p><strong>Renewable Energy</strong>:<br />
Forecasting solar radiation and wind patterns enables efficient integration of renewable energy sources into power grids.</p></li>
</ol>
<p><strong>Revival of Interest with AI and Deep Learning</strong>
In recent years, the advent of <strong>AI</strong> and <strong>deep learning models</strong> such as <strong>recurrent neural networks (RNNs)</strong>, <strong>transformers</strong>, and even <strong>large language models (LLMs)</strong> has revolutionized time series forecasting. These models:</p>
<ul class="simple">
<li><p>Capture complex temporal dependencies and nonlinear patterns in ways that traditional statistical models often cannot.</p></li>
<li><p>Enable integration of diverse geoscientific datasets, including time series with spatial and multivariate dimensions.</p></li>
<li><p>Open new frontiers in tackling previously intractable problems, such as long-term climate forecasting and predicting rare geophysical events.</p></li>
</ul>
<p><strong>Goals of the Lecture</strong>
In this lecture, we will:</p>
<ol class="simple">
<li><p>Explore the role of time series forecasting in geoscientific research.</p></li>
<li><p>Develop and analyze a geoscientifically inspired toy dataset.</p></li>
<li><p>Compare approaches:</p>
<ul class="simple">
<li><p><strong>Baseline statistical models</strong> for their simplicity and robustness.</p></li>
<li><p><strong>Classic machine learning models</strong> to understand feature engineering and generalization.</p></li>
<li><p><strong>Deep learning models</strong> to harness the power of neural networks for temporal prediction.</p></li>
</ul>
</li>
<li><p>Evaluate these methods in terms of their predictive performance, interpretability, and scalability to real-world geoscientific problems.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="important-concepts-in-time-series-forecasting">
<h2>2. Important Concepts in Time series forecasting<a class="headerlink" href="#important-concepts-in-time-series-forecasting" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p><strong>Context</strong>
In <strong>statistical learning</strong>, the context in a time series can refer to the historical data or the portion of the past observations used to predict future values. This historical context is essential for capturing temporal dependencies, trends, seasonality, and other repeating patterns. The amount of context needed depends on the nature of the dataset—for instance, long-term climatic forecasts often require years of past data, while seismic activity predictions may focus on shorter, event-driven contexts.
In <strong>scientific inquiry</strong>, the context might be the scientific knowledge or additional “covariate” (e.g., temperature and precipitation) that might help inform the forecast.</p></li>
<li><p><strong>Look-Back Window</strong> defines the specific number of past time steps used as input to the forecasting model, equivalent to the <em><strong>context</strong></em>. For example:</p>
<ul class="simple">
<li><p>A short look-back window might capture local or short-term dependencies (e.g., hourly temperature changes).</p></li>
<li><p>A long look-back window can capture more extended trends and seasonal patterns (e.g., annual temperature cycles). Choosing an appropriate look-back window is a balance: too short and the model may miss important patterns, too long and it may include irrelevant or noisy data.</p></li>
</ul>
</li>
<li><p><strong>Horizon</strong> refers to how far into the future the model predicts. This can range from:</p>
<ul class="simple">
<li><p>Short-term horizons, such as the next hour or day, where temporal dependencies are strong and relatively predictable.</p></li>
<li><p>Long-term horizons, such as monthly or annual predictions, where uncertainty grows due to external influences, stochastic variability, and system non-linearity.</p></li>
<li><p><strong>Prediction Length</strong> defines the number of future time steps forecasted in a single prediction. Models can be designed to:</p></li>
</ul>
</li>
<li><p><strong>Increasing Uncertainty with Longer Horizons</strong>
Forecast accuracy generally decreases as the prediction horizon lengthens. This is because:</p>
<ul class="simple">
<li><p><em>Error propagation</em>: In multi-step predictions, small errors in early predictions compound as they are fed into the model for subsequent predictions.</p></li>
<li><p><em>Complexity of future influences</em>: Longer horizons are more affected by external and often unpredictable factors, such as sudden climatic events or anomalous geophysical activity.</p></li>
<li><p><em>Loss of signal strength</em>: Temporal correlations weaken over time, making it harder for models to extract meaningful patterns for far-future predictions.</p></li>
</ul>
</li>
</ol>
</section>
<hr class="docutils" />
<section id="toy-dataset">
<h2>3. Toy Dataset<a class="headerlink" href="#toy-dataset" title="Permalink to this headline">#</a></h2>
<p>We’ll generate synthetic geoscientific time series data simulating <strong>monthly surface temperature anomalies</strong> for a fictional region over 30 years. The data will incorporate:</p>
<ol class="simple">
<li><p><strong>Seasonality</strong>: A sinusoidal signal with annual cycles.</p></li>
<li><p><strong>Trend</strong>: A small upward trend over time (e.g., global warming).</p></li>
<li><p><strong>Noise</strong>: Gaussian noise to simulate variability.</p></li>
<li><p><strong>Anomalies</strong>: Sudden deviations simulating geoscientific events like volcanic eruptions or ENSO effects.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Generate time series</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;1990-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2019-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

<span class="c1"># Components</span>
<span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># Linear trend</span>
<span class="n">seasonality</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>  <span class="c1"># Annual cycle</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># Random noise</span>
<span class="n">anomalies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">anomalies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Sudden anomalies</span>

<span class="c1"># Final series</span>
<span class="n">temperature_anomalies</span> <span class="o">=</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">seasonality</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">+</span> <span class="n">anomalies</span>

<span class="c1"># Create DataFrame</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">:</span> <span class="n">temperature_anomalies</span><span class="p">})</span>
<span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;geoscientific_time_series.csv&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Temperature_Anomaly</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1990-01-31</th>
      <td>0.248357</td>
    </tr>
    <tr>
      <th>1990-02-28</th>
      <td>0.936439</td>
    </tr>
    <tr>
      <th>1990-03-31</th>
      <td>2.067037</td>
    </tr>
    <tr>
      <th>1990-04-30</th>
      <td>2.778228</td>
    </tr>
    <tr>
      <th>1990-05-31</th>
      <td>1.637258</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the data</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Simulated Temperature Anomalies&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Anomaly&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/mlgeo_4.10_timeseriesforecast_2_0.png" src="../_images/mlgeo_4.10_timeseriesforecast_2_0.png" />
</div>
</div>
<p><strong>Define Context and Horizon</strong></p>
<p>Given this long time series, we will focus on making a rolling forecast by defining a context and a horizon window.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define a context and a horizon window</span>
<span class="n">context_window</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">horizon_window</span> <span class="o">=</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split data into train/test, which is basically the context (train) and horizon (test)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">][:</span><span class="o">-</span><span class="n">horizon_window</span><span class="p">]</span> <span class="c1"># context window here is the entire thing</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">][</span><span class="o">-</span><span class="n">horizon_window</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="forecasting-methods">
<h2>3. Forecasting Methods<a class="headerlink" href="#forecasting-methods" title="Permalink to this headline">#</a></h2>
<section id="baseline-statistical-forecasts">
<h3>3.1 Baseline: Statistical Forecasts<a class="headerlink" href="#baseline-statistical-forecasts" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p><strong>Naive Forecast</strong>: Use the last observed value as the next prediction.</p></li>
<li><p><strong>Seasonal Naive Forecast</strong>: Use the value from the same season in the previous year.</p></li>
<li><p><strong>ARIMA</strong>: Fit an AutoRegressive Integrated Moving Average model.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.tsa.arima.model</span> <span class="kn">import</span> <span class="n">ARIMA</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="c1"># Naive Forecast</span>
<span class="n">naive_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">horizon_window</span><span class="p">)</span>
<span class="n">naive_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">naive_forecast</span><span class="p">))</span>
<span class="n">naive_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">test</span> <span class="o">-</span> <span class="n">naive_forecast</span><span class="p">))</span>

<span class="c1"># seasonal naive forecast</span>
<span class="n">seasonal_naive_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">]]</span> <span class="o">*</span> <span class="n">horizon_window</span><span class="p">)</span>
<span class="n">seasonal_naive_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">seasonal_naive_forecast</span><span class="p">))</span>
<span class="n">seasonal_naive_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">test</span> <span class="o">-</span> <span class="n">seasonal_naive_forecast</span><span class="p">))</span>

<span class="c1"># ARIMA Model</span>
<span class="n">arima_model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">arima_forecast</span> <span class="o">=</span> <span class="n">arima_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">horizon_window</span><span class="p">)</span>
<span class="n">arima_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">arima_forecast</span><span class="p">))</span>
<span class="n">arima_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">test</span> <span class="o">-</span> <span class="n">arima_forecast</span><span class="p">))</span>

<span class="c1"># report all evaluation metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Naive RMSE: </span><span class="si">{</span><span class="n">naive_rmse</span><span class="si">}</span><span class="s2">, Naive MAE: </span><span class="si">{</span><span class="n">naive_mae</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seasonal Naive RMSE: </span><span class="si">{</span><span class="n">seasonal_naive_rmse</span><span class="si">}</span><span class="s2">, Seasonal Naive MAE: </span><span class="si">{</span><span class="n">seasonal_naive_mae</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARIMA RMSE: </span><span class="si">{</span><span class="n">arima_rmse</span><span class="si">}</span><span class="s2">, ARIMA MAE: </span><span class="si">{</span><span class="n">arima_mae</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/marinedenolle/opt/miniconda3/envs/mlgeo/lib/python3.9/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency M will be used.
  self._init_dates(dates, freq)
/Users/marinedenolle/opt/miniconda3/envs/mlgeo/lib/python3.9/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency M will be used.
  self._init_dates(dates, freq)
/Users/marinedenolle/opt/miniconda3/envs/mlgeo/lib/python3.9/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency M will be used.
  self._init_dates(dates, freq)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Naive RMSE: 2.389823903102479, Naive MAE: 2.2973182078545107
Seasonal Naive RMSE: 1.5820363949721554, Seasonal Naive MAE: 1.4384894213432322
ARIMA RMSE: 0.5550037051446414, ARIMA MAE: 0.4465414221142508
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/marinedenolle/opt/miniconda3/envs/mlgeo/lib/python3.9/site-packages/statsmodels/base/model.py:607: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  warnings.warn(&quot;Maximum Likelihood optimization failed to &quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the three predictions from the base models</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">arima_forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARIMA Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">naive_forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARIMA Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">seasonal_naive_forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARIMA Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ARIMA Forecast vs Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Anomaly&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/mlgeo_4.10_timeseriesforecast_8_0.png" src="../_images/mlgeo_4.10_timeseriesforecast_8_0.png" />
</div>
</div>
</section>
<section id="classic-machine-learning">
<h3>3.2. Classic Machine Learning<a class="headerlink" href="#classic-machine-learning" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Use <strong>Lag Features</strong> and <strong>Seasonality Features</strong> as input.</p></li>
<li><p>Algorithms: Linear Regression, Random Forest, Gradient Boosting.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Create context features</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">context_window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span> <span class="c1"># shift the data</span>
<span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Create training data as the past, test data as the future </span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Gradient Boosting Regressor</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">gbr_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="n">gbr_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gradient Boosting RMSE: </span><span class="si">{</span><span class="n">gbr_rmse</span><span class="si">}</span><span class="s2"> , Gradient Boosting MAE: </span><span class="si">{</span><span class="n">gbr_mae</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># plot the predictions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">):],</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GBR Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gradient Boosting Forecast vs Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Anomaly&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Gradient Boosting RMSE: 0.6784327786162885 , Gradient Boosting MAE: 0.5225129530636484
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x30ca181c0&gt;
</pre></div>
</div>
<img alt="../_images/mlgeo_4.10_timeseriesforecast_10_2.png" src="../_images/mlgeo_4.10_timeseriesforecast_10_2.png" />
</div>
</div>
</section>
<section id="deep-learning">
<h3>3.3 Deep Learning<a class="headerlink" href="#deep-learning" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Models: <strong>RNNs, LSTMs, GRUs</strong>, or <strong>Transformers</strong>.</p></li>
<li><p>Framework: PyTorch.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>

<span class="c1"># Custom dataset for PyTorch</span>
<span class="k">class</span> <span class="nc">TimeSeriesDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">context_window</span><span class="p">,</span> <span class="n">horizon_window</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">context_window</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">context_window</span><span class="o">+</span><span class="n">horizon_window</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">context_window</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">context_window</span><span class="o">+</span><span class="n">horizon_window</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">context_window</span><span class="o">+</span><span class="n">horizon_window</span><span class="p">))]</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># RNN Model</span>
<span class="k">class</span> <span class="nc">RNNModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">h_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">h_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare data</span>
<span class="n">ts_data</span> <span class="o">=</span> <span class="n">TimeSeriesDataset</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">context_window</span><span class="p">,</span> <span class="n">horizon_window</span><span class="p">)</span>
<span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ts_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model, loss, and optimizer</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context_window</span><span class="p">,</span> <span class="n">horizon_window</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RNNModel</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">context_window</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="n">horizon_window</span><span class="p">)</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12 6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Training loop</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="c1"># X_batch = X_batch.unsqueeze(-1)  # Add feature dimension</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, Loss: </span><span class="si">{</span><span class="n">epoch_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 0, Loss: 3.00634267216637
Epoch: 1, Loss: 2.6486164728800454
Epoch: 2, Loss: 2.626796557789757
Epoch: 3, Loss: 2.6268500714074996
Epoch: 4, Loss: 2.6511067549387612
Epoch: 5, Loss: 2.6555847894577753
Epoch: 6, Loss: 2.6372431346348355
Epoch: 7, Loss: 2.627526181084769
Epoch: 8, Loss: 2.7000722998664495
Epoch: 9, Loss: 2.6251020034154258
Epoch: 10, Loss: 2.608908255894979
Epoch: 11, Loss: 2.613211399032956
Epoch: 12, Loss: 2.6141854581378756
Epoch: 13, Loss: 2.620620619683039
Epoch: 14, Loss: 2.624014150528681
Epoch: 15, Loss: 2.605562698273432
Epoch: 16, Loss: 2.6024255752563477
Epoch: 17, Loss: 2.585343973977225
Epoch: 18, Loss: 2.5852765242258706
Epoch: 19, Loss: 2.665037166504633
Epoch: 20, Loss: 2.6180632625307356
Epoch: 21, Loss: 2.6397100516727994
Epoch: 22, Loss: 2.572316567103068
Epoch: 23, Loss: 2.571771576291039
Epoch: 24, Loss: 2.616808993475778
Epoch: 25, Loss: 2.5992123512994674
Epoch: 26, Loss: 2.5893679005759105
Epoch: 27, Loss: 2.5868957894189015
Epoch: 28, Loss: 2.5527749913079396
Epoch: 29, Loss: 2.5988870348249162
Epoch: 30, Loss: 2.5735259453455606
Epoch: 31, Loss: 2.615531495639256
Epoch: 32, Loss: 2.623429911477225
Epoch: 33, Loss: 2.567932753335862
Epoch: 34, Loss: 2.588108857472738
Epoch: 35, Loss: 2.569101481210618
Epoch: 36, Loss: 2.5912431478500366
Epoch: 37, Loss: 2.5857595716203963
Epoch: 38, Loss: 2.5676723207746233
Epoch: 39, Loss: 2.5795442263285318
Epoch: 40, Loss: 2.622153815769014
Epoch: 41, Loss: 2.598675188564119
Epoch: 42, Loss: 2.568843750726609
Epoch: 43, Loss: 2.5866817860376266
Epoch: 44, Loss: 2.631495998019264
Epoch: 45, Loss: 2.6336796397254583
Epoch: 46, Loss: 2.586955535979498
Epoch: 47, Loss: 2.6301064434505643
Epoch: 48, Loss: 2.585471754982358
Epoch: 49, Loss: 2.547369820731027
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate</span>
<span class="n">test_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">context_window</span><span class="o">+</span><span class="n">horizon_window</span><span class="p">):</span><span class="o">-</span><span class="n">horizon_window</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">rnn_forecast</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>

<span class="c1"># Assuming test contains the ground truth values for the last 12 months</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature_Anomaly&#39;</span><span class="p">][</span><span class="o">-</span><span class="n">horizon_window</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Calculate RMSE</span>
<span class="n">rnn_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">rnn_forecast</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RNN RMSE: </span><span class="si">{</span><span class="n">rnn_rmse</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Calculate MAE</span>
<span class="n">rnn_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">rnn_forecast</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RNN MAE: </span><span class="si">{</span><span class="n">rnn_mae</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RNN RMSE: 0.64634883661374
RNN MAE: 0.47775794587681136
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="comparison-and-discussion">
<h2>4. Comparison and Discussion<a class="headerlink" href="#comparison-and-discussion" title="Permalink to this headline">#</a></h2>
<ol>
<li><p><strong>Evaluation Metrics</strong>:</p>
<ol class="simple">
<li><p>Mean Squared Error (MSE)</p>
<ul class="simple">
<li><p><strong>Use</strong>: Measures the average squared difference between predicted and actual values. It penalizes larger errors more heavily.</p></li>
<li><p><strong>Considerations</strong>: While useful, MSE doesn’t account for trends or seasonal components, making it potentially less informative for complex time series (e.g., those with strong seasonality).</p></li>
<li><p><strong>Best for</strong>: General forecasts when trends and magnitudes of errors are important.</p></li>
</ul>
</li>
<li><p>Mean Absolute Error (MAE)</p>
<ul class="simple">
<li><p><strong>Use</strong>: Measures the average of the absolute errors. Unlike MSE, it doesn’t heavily penalize outliers.</p></li>
<li><p><strong>Considerations</strong>: MAE can be more robust when there are outliers, which is common in power-law distributed data. However, it also doesn’t account for trends or periodicity.</p></li>
<li><p><strong>Best for</strong>: Situations where the model needs to be evaluated without over-penalizing large errors (e.g., for power-law distributions).</p></li>
</ul>
</li>
<li><p>Root Mean Squared Error (RMSE)</p>
<ul class="simple">
<li><p><strong>Use</strong>: RMSE is the square root of MSE, offering a more interpretable metric in terms of the units of the original data.</p></li>
<li><p><strong>Considerations</strong>: Like MSE, it is sensitive to outliers. For time series with strong trends, RMSE can be large if forecasts consistently lag or lead trends.</p></li>
<li><p><strong>Best for</strong>: General forecasting, but less ideal for highly seasonal or trending data unless seasonality is detrended.</p></li>
</ul>
</li>
<li><p>Mean Absolute Percentage Error (MAPE)</p>
<ul class="simple">
<li><p><strong>Use</strong>: Measures the percentage error between the forecast and the actual value. It normalizes the error by the magnitude of the actual values.</p></li>
<li><p><strong>Considerations</strong>: MAPE can be problematic when actual values are close to zero (leading to high percentages). It is also less effective for power-law distributions where low-frequency, high-magnitude events can skew the results.</p></li>
<li><p><strong>Best for</strong>: Forecasts where relative error matters more than absolute error, especially for non-power-law distributed data.</p></li>
</ul>
</li>
<li><p>Symmetric Mean Absolute Percentage Error (sMAPE)</p>
<ul class="simple">
<li><p><strong>Use</strong>: A variation of MAPE that adjusts for issues with division by zero and symmetry in errors.</p></li>
<li><p><strong>Considerations</strong>: Like MAPE, it works better for data without extreme outliers or heavy-tailed distributions.</p></li>
<li><p><strong>Best for</strong>: Relative error measurement, especially for periodic or seasonal data where symmetry in error matters.</p></li>
</ul>
</li>
<li><p>Mean Squared Logarithmic Error (MSLE)</p>
<ul class="simple">
<li><p><strong>Use</strong>: Useful when the forecast error should be penalized more when underestimating than when overestimating, especially for datasets with a wide dynamic range.</p></li>
<li><p><strong>Considerations</strong>: Works well for power-law distributions or data with large variations in scale, as it compresses the impact of large errors.</p></li>
<li><p><strong>Best for</strong>: Power-law distributed data where large-magnitude events need reduced influence.</p></li>
</ul>
</li>
<li><p>Autocorrelation of Residuals</p>
<ul class="simple">
<li><p><strong>Use</strong>: Measures whether forecast errors (residuals) are correlated over time, indicating if the model has captured the structure of the data.</p></li>
<li><p><strong>Considerations</strong>: Important for time series with periodicity, as autocorrelated residuals suggest that the model has failed to account for recurring patterns or cycles.</p></li>
<li><p><strong>Best for</strong>: Time series with strong periodicity or seasonality.</p></li>
</ul>
</li>
<li><p>Trend-Corrected Metrics:</p>
<ul class="simple">
<li><p><strong>Use</strong>: Metrics like Mean Absolute Scaled Error (MASE) help correct for trend or seasonality. MASE normalizes the error by a benchmark model (e.g., a naïve forecast).</p></li>
<li><p><strong>Considerations</strong>: It adjusts for trend and seasonality, making it more reliable for data that has both components.</p></li>
<li><p><strong>Best for</strong>: Data with both trends and periodicity.</p></li>
</ul>
</li>
<li><p>Spectral Score (for Periodic Data)</p>
<ul class="simple">
<li><p><strong>Use</strong>: Measures the alignment between the frequency components of the forecast and the actual data, useful for evaluating models on data with clear periodicity.</p></li>
<li><p><strong>Considerations</strong>: This metric focuses on the frequency domain, complementing time-domain error metrics for highly periodic or cyclical data.</p></li>
<li><p><strong>Best for</strong>: Time series dominated by periodicity or cyclical patterns.</p></li>
</ul>
</li>
<li><p>Quantile Loss/Pinball Loss</p></li>
</ol>
<ul class="simple">
<li><p><strong>Use</strong>: Evaluates the forecast’s ability to predict different quantiles, especially useful when forecasting intervals or uncertainty bounds.</p></li>
<li><p><strong>Considerations</strong>: Works well with power-law distributions where you care about upper or lower tail behavior (e.g., rare but extreme events).</p></li>
<li><p><strong>Best for</strong>: Time series with significant outliers or fat-tailed distributions.</p></li>
</ul>
<ol class="simple">
<li><p>Directional Accuracy</p></li>
</ol>
<ul class="simple">
<li><p><strong>Use</strong>: Measures whether the forecast correctly predicts the direction of change (up or down).</p></li>
<li><p><strong>Considerations</strong>: In trending time series, this metric helps assess whether the forecast captures the general movement.</p></li>
<li><p><strong>Best for</strong>: Data with strong trends, where capturing the direction of change is more important than minimizing the magnitude of error.</p></li>
</ul>
</li>
</ol>
<p>Metric Selection Based on Data Characteristics</p>
<ul class="simple">
<li><p><strong>Trends</strong>: Use trend-corrected metrics (MASE) and directional accuracy. Combine with RMSE or MAE to evaluate overall fit.</p></li>
<li><p><strong>Periodicity</strong>: Autocorrelation of residuals, spectral score, or sMAPE.</p></li>
<li><p><strong>Power-Law Distributions</strong>: Quantile loss, MSLE, or robust metrics like MAE that handle outliers better than squared-error metrics.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Assuming you have the RMSE and MAE values for each model</span>
<span class="c1"># Replace these values with the actual values from your models</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;CML&#39;</span><span class="p">,</span> <span class="s1">&#39;DL&#39;</span><span class="p">],</span>
    <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">arima_rmse</span><span class="p">,</span> <span class="n">gbr_rmse</span><span class="p">,</span> <span class="n">rnn_mae</span><span class="p">],</span>  <span class="c1"># Replace with actual RMSE values</span>
    <span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">arima_rmse</span><span class="p">,</span> <span class="n">gbr_rmse</span><span class="p">,</span> <span class="n">rnn_rmse</span><span class="p">]</span>    <span class="c1"># Replace with actual MAE values</span>
<span class="p">}</span>

<span class="c1"># Create a DataFrame to store the results</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Print the results table</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Save the results to a CSV file</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;model_performance_comparison.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      Model      RMSE       MAE
0  Baseline  0.555004  0.555004
1       CML  0.678433  0.678433
2        DL  0.477758  0.646349
</pre></div>
</div>
</div>
</div>
</section>
<section id="testing-foundation-models">
<h2>5. Testing Foundation Models<a class="headerlink" href="#testing-foundation-models" title="Permalink to this headline">#</a></h2>
<p>In this example, we will test <strong>Chronos</strong> on canonical geoscientific data sets chosen to be representative of geoscience/geophysics:</p>
<ol class="simple">
<li><p>earthquake catalogs from SoCal</p></li>
<li><p>earthquake ground motion waveforms</p></li>
<li><p>near surface properties (seismic velocities, temperature, soil moisture)</p></li>
<li><p>ice velocity from greenland</p></li>
<li><p>GPS positions along a plate boundary that captures seasons and tectonic loading.
The data files are gathered on this repository: <a class="reference external" href="https://github.com/UW-MLGEO/MLGeo-dataset">https://github.com/UW-MLGEO/MLGeo-dataset</a></p></li>
</ol>
<p>The data has been prepared as CSV files with times series.
The forescasts are added to the CSV files under key attributes “Chronos-zero-shot”.</p>
<p>Limitations by <a class="reference external" href="https://arxiv.org/pdf/2403.07815">Chronos</a>. Chronos uses large language models at its core for forecasting time series. The time series is “tokenized” to convert from an array of floats into contect tokens.</p>
<p>By Marine Denolle (<a class="reference external" href="mailto:mdenolle&#37;&#52;&#48;uw&#46;edu">mdenolle<span>&#64;</span>uw<span>&#46;</span>edu</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> pip install chronos-forecasting
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">chronos</span> <span class="kn">import</span> <span class="n">ChronosPipeline</span><span class="p">,</span> <span class="n">ChronosBoltPipeline</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># Set the font style and size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;font.family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span>
    <span class="s1">&#39;font.serif&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;DejaVu Sans&#39;</span><span class="p">],</span>
    <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># benchmarking with ARIMA</span>
<span class="o">!</span>pip install statsmodels
<span class="kn">from</span> <span class="nn">statsmodels.tsa.arima.model</span> <span class="kn">import</span> <span class="n">ARIMA</span>

<span class="c1"># Assuming df is your DataFrame and &#39;datetime&#39; is your datetime column</span>
<span class="c1"># df[&quot;datetime&quot;] = pd.to_datetime(df[&quot;datetime&quot;])</span>
<span class="c1"># df.set_index(&quot;datetime&quot;, inplace=True)</span>

<span class="c1"># # Assuming &#39;value&#39; is the column you want to forecast</span>
<span class="c1"># data = df[&#39;value&#39;]</span>

<span class="c1"># Fit ARIMA model</span>
<span class="c1"># model = ARIMA(data, order=(5, 1, 0))  # (p, d, q) order, adjust as needed</span>
<span class="c1"># model_fit = model.fit()</span>

<span class="c1"># # Make predictions</span>
<span class="c1"># forecast_steps = 10  # Number of steps to forecast</span>
<span class="c1"># forecast = model_fit.forecast(steps=forecast_steps)</span>

<span class="c1"># # Plot the results</span>
<span class="c1"># plt.figure(figsize=(10, 6))</span>
<span class="c1"># plt.plot(data, label=&#39;Actual&#39;)</span>
<span class="c1"># plt.plot(forecast, label=&#39;Forecast&#39;, color=&#39;red&#39;)</span>
<span class="c1"># plt.legend()</span>
<span class="c1"># plt.show()</span>

<span class="c1"># # Print forecasted values</span>
<span class="c1"># print(forecast)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_timeseries</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">ChronosBoltPipeline</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
    <span class="s2">&quot;amazon/chronos-bolt-base&quot;</span><span class="p">,</span>
    <span class="n">device_map</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span>  <span class="c1"># use &quot;cpu&quot; for CPU inference and &quot;mps&quot; for Apple Silicon</span>
    <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">chronos</span> <span class="kn">import</span> <span class="n">BaseChronosPipeline</span><span class="p">,</span> <span class="n">ChronosPipeline</span><span class="p">,</span> <span class="n">ChronosBoltPipeline</span>

<span class="nb">print</span><span class="p">(</span><span class="n">BaseChronosPipeline</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>  <span class="c1"># for Chronos models</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ChronosPipeline</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>  <span class="c1"># for Chronos models</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        Get forecasts for the given time series. Predictions will be
        returned in fp32 on the cpu.

        Parameters
        ----------
        context
            Input series. This is either a 1D tensor, or a list
            of 1D tensors, or a 2D tensor whose first dimension
            is batch. In the latter case, use left-padding with
            ``torch.nan`` to align series of different lengths.
        prediction_length
            Time steps to predict. Defaults to a model-dependent
            value if not given.

        Returns
        -------
        forecasts
            Tensor containing forecasts. The layout and meaning
            of the forecasts values depends on ``self.forecast_type``.
        

        Get forecasts for the given time series.

        Refer to the base method (``BaseChronosPipeline.predict``)
        for details on shared parameters.

        Additional parameters
        ---------------------
        num_samples
            Number of sample paths to predict. Defaults to what
            specified in ``self.model.config``.
        temperature
            Temperature to use for generating sample tokens.
            Defaults to what specified in ``self.model.config``.
        top_k
            Top-k parameter to use for generating sample tokens.
            Defaults to what specified in ``self.model.config``.
        top_p
            Top-p parameter to use for generating sample tokens.
            Defaults to what specified in ``self.model.config``.
        limit_prediction_length
            Force prediction length smaller or equal than the
            built-in prediction length from the model. False by
            default. When true, fail loudly if longer predictions
            are requested, otherwise longer predictions are allowed.

        Returns
        -------
        samples
            Tensor of sample forecasts, of shape
            (batch_size, num_samples, prediction_length).
        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ChronosBoltPipeline</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>  <span class="c1"># for Chronos-Bolt models</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        Get forecasts for the given time series.

        Refer to the base method (``BaseChronosPipeline.predict``)
        for details on shared parameters.
        Additional parameters
        ---------------------
        limit_prediction_length
            Force prediction length smaller or equal than the
            built-in prediction length from the model. False by
            default. When true, fail loudly if longer predictions
            are requested, otherwise longer predictions are allowed.

        Returns
        -------
        torch.Tensor
            Forecasts of shape (batch_size, num_quantiles, prediction_length)
            where num_quantiles is the number of quantiles the model has been
            trained to output. For official Chronos-Bolt models, the value of
            num_quantiles is 9 for [0.1, 0.2, ..., 0.9]-quantiles.

        Raises
        ------
        ValueError
            When limit_prediction_length is True and the prediction_length is
            greater than model&#39;s trainig prediction_length.
        
</pre></div>
</div>
</div>
</div>
<p>Some functions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reshape_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name_of_target</span><span class="o">=</span><span class="s2">&quot;count&quot;</span> <span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a list of time series from the given DataFrame.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df (pd.DataFrame): The input DataFrame containing a &#39;datetime&#39; column.</span>
<span class="sd">    n_timeseries (int): Number of time series to generate.</span>
<span class="sd">    duration_years (int): Duration of each time series in years.</span>
<span class="sd">    resample_period (str): Resampling period (e.g., &#39;D&#39; for daily).</span>

<span class="sd">    Returns:</span>
<span class="sd">    list: A list of DataFrames, each containing a time series.</span>
<span class="sd">    pd.DataFrame: A wide-format DataFrame containing the time series.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">)]</span>
    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">kk</span> <span class="o">&lt;</span> <span class="n">n_timeseries</span><span class="p">:</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
        <span class="c1"># Create a time series for the specified duration</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">duration_years</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_date</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="k">continue</span>    <span class="c1"># Skip if the end date exceeds the maximum date in the catalog</span>
        <span class="c1"># Create a time series from the catalog and select only the date time and target columns</span>
        <span class="n">time_series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)][[</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">name_of_target</span><span class="p">]]</span>
        <span class="n">time_series</span> <span class="o">=</span> <span class="n">time_series</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span>
        <span class="c1"># time_series = time_series.resample(resample_period).mean().interpolate() # resample and interpolate</span>
        <span class="n">time_series</span> <span class="o">=</span> <span class="n">time_series</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="c1">#(method=&quot;ffill&quot;) # forward fill</span>
        <span class="n">time_series</span> <span class="o">=</span> <span class="n">time_series</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="c1">#(method=&quot;bfill&quot;) # backward fill</span>
        <span class="n">time_series</span> <span class="o">=</span> <span class="n">time_series</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="c1"># reset index to keep datetime as a column</span>
        <span class="c1"># remove the &quot;datetime&quot; column to the time_series</span>
        
        <span class="n">df_list</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_series</span>
        <span class="n">kk</span> <span class="o">+=</span> <span class="mi">1</span> 
    <span class="n">df_list_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">):</span>
        <span class="n">df_list_count</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="n">name_of_target</span><span class="p">]</span>
        <span class="n">df_list_count</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_list_count</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_</span><span class="si">{</span><span class="n">ik</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_wide</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list_count</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># find the sampling rate dt as the difference between the first two dates</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="c1"># convert dt to days</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sampling rate </span><span class="si">{:.2f}</span><span class="s2"> days&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>

    <span class="c1"># create a time array that is the index of the time series and convert the dae</span>
    <span class="n">df_wide</span><span class="p">[</span><span class="s2">&quot;time_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="p">))</span> <span class="c1">#* pd.Timedelta(days=dt)</span>
    <span class="c1"># move the last column to the first position</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

    <span class="c1"># rename columns to target_ID except for the first column that is a datetime</span>
    <span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;target_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;time_index&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
    <span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> 
    
    <span class="k">return</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">df_wide</span>

<span class="c1"># Example usage:</span>
<span class="c1"># df_list,df_wide = reshape_time_series(df, n_timeseries=20, duration_years=2, resample_period=&#39;D&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predict_chronos</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predict_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make predictions for the given time series data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df (pd.DataFrame): The input DataFrame containing the time series data.</span>

<span class="sd">    Returns:</span>
<span class="sd">    forecast_mean (np.array): The mean forecasted values for the time series.</span>
<span class="sd">    lower_bound (np.array): The 5% lower bound of the forecasted values.</span>
<span class="sd">    upper_bound (np.array): The 95% upper bound of the forecasted values.</span>
<span class="sd">    mean_mae (float): The mean absolute error of the forecasted values.</span>
<span class="sd">    no_var_mae (float): The mean absolute error assuming no change in the time series.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure df[&#39;Date&#39;] is in datetime format</span>
    <span class="c1"># df[&#39;datetime&#39;] = pd.to_datetime(df[&#39;datetime&#39;])</span>

    <span class="c1"># Select the first n_timeseries columns for forecasting</span>
    <span class="n">columns_to_forecast</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n_timeseries</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># +1 to skip the &#39;Date&#39; column</span>

    <span class="c1"># Calculate the split index for training</span>
    <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">predict_length</span><span class="p">)</span>

    <span class="c1"># Split the data into training and evaluation sets for all selected columns</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_to_forecast</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
    <span class="n">eval_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns_to_forecast</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>

    <span class="c1"># Convert the training data to a higher-dimensional tensor</span>
    <span class="n">train_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># Perform the forecasting using the training data</span>
    <span class="c1"># forecast = pipeline.predict(</span>
    <span class="c1">#     context=train_tensor,</span>
    <span class="c1">#     prediction_length=len(eval_data),  # Predict the same length as the evaluation set</span>
    <span class="c1">#     num_samples=50,</span>
    <span class="c1"># )</span>
    <span class="n">forecast</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">context</span><span class="o">=</span><span class="n">train_tensor</span><span class="p">,</span>
        <span class="n">prediction_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_data</span><span class="p">))</span>  <span class="c1"># Predict the same length as the evaluation set</span>
    <span class="c1"># )</span>

    <span class="c1"># Take the mean across the samples (axis=1) for each time series</span>
    <span class="n">forecast_mean</span> <span class="o">=</span> <span class="n">forecast</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="c1"># lower_bound = forecast.quantile(0.05, dim=1).squeeze().numpy()</span>
    <span class="c1"># upper_bound = forecast.quantile(0.95, dim=1).squeeze().numpy()</span>


    <span class="n">mae</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1"># Calculate and print the MAE for each time series</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_forecast</span><span class="p">):</span>
        <span class="c1"># Calculate MAE for the current time series</span>
        <span class="n">mae</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
        
        <span class="c1"># Print the MAE</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Absolute Error (MAE) for </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mae</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">mean_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean of forecast MAEs = </span><span class="si">{</span><span class="n">mean_mae</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate and print the MASE for each time series</span>
    <span class="n">mase</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_forecast</span><span class="p">):</span>
        <span class="c1"># Calculate MASE for the current time series</span>
        <span class="n">mase</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        
        <span class="c1"># Print the MASE</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Absolute Scaled Error (MASE) for </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">mean_mase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mase</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean of forecast MAEs = </span><span class="si">{</span><span class="n">mean_mase</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="c1"># Baseline model: ARIMA</span>
    <span class="n">mae_arima</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1"># Calculate and print the MAE for each time series</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_forecast</span><span class="p">):</span>
        <span class="c1"># Calculate MAE for the current time series</span>
        <span class="n">mae_arima</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
        
        <span class="c1"># Print the MAE</span>
        <span class="c1"># print(f&#39;MAE assuming d/dt=0 for {column_name}: {mae_nochangemodel[-1]}&#39;)</span>

    <span class="n">mae_arima_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mae_arima</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean of ARIMA MAEs = </span><span class="si">{</span><span class="n">mae_arima_mean</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">forecast</span><span class="p">,</span><span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">mae_arima_mean</span><span class="p">,</span> <span class="n">split_index</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="k">def</span> <span class="nf">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;geo-forecast.png&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the forecasted values along with the confidence intervals.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    n_timeseries (int): Number of time series to plot.</span>
<span class="sd">    df_wide (pd.DataFrame): The wide-format DataFrame containing the time series.</span>
<span class="sd">    split_index (int): The index at which the training data ends (or context data) and evaluation (or forecast) data begins.</span>
<span class="sd">    forecast (np.array): The forecasted values for the time series.</span>
<span class="sd">    filename (str): The filename to save the plot.</span>


<span class="sd">    Returns:</span>
<span class="sd">    None</span>


<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Determine the number of rows and columns for the subplots</span>
    <span class="n">n_timeseries</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>  <span class="c1"># Cap the number of time series to 12</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_timeseries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Select the first n_timeseries columns for forecasting</span>
    <span class="n">columns_to_forecast</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n_timeseries</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># +1 to skip the &#39;Date&#39; column</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">forecast_mean</span> <span class="o">=</span> <span class="n">forecast</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">forecast_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Layout the subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Flatten the 2D array of axes for easy indexing</span>
    <span class="k">if</span> <span class="n">n_timeseries</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        


    <span class="c1"># Split the data into training and evaluation sets for all selected columns</span>
    <span class="c1"># train_data = df_wide[columns_to_forecast].iloc[:split_index]</span>
    <span class="n">eval_data</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">columns_to_forecast</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>


    <span class="c1"># Calculate and print the MASE for each time series</span>
    <span class="n">mase</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_forecast</span><span class="p">):</span>
        <span class="c1"># Calculate MASE for the current time series</span>
        <span class="n">mase</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="o">-</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        
    <span class="n">mean_mase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mase</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean of forecast MASEs = </span><span class="si">{</span><span class="n">mean_mase</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">)</span>
    <span class="c1"># Iterate over the first n_timeseries and plot</span>
    <span class="k">if</span> <span class="n">n_timeseries</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_forecast</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_timeseries</span><span class="p">]):</span>
            <span class="c1"># Plot the original data</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">],</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">column_name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
            
            <span class="c1"># Calculate the 5th and 95th percentiles for the confidence interval</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Plot the forecast</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_index</span><span class="p">:],</span> <span class="n">forecast_mean</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot the confidence intervals</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_index</span><span class="p">:],</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> 
                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% CI&#39;</span><span class="p">)</span>


            <span class="c1"># set the x-axis labels as the number of days</span>
            <span class="c1"># axes[i].set_xticks(np.arange(0,len(df_wide[&#39;datetime&#39;]), step=30))</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

            <span class="c1"># Plot the evaluation data for reference</span>
            <span class="c1"># axes[i].plot(df_wide[&#39;datetime&#39;].iloc[split_index:], eval_data[column_name].values, &#39;--&#39;, label=&#39;Evaluation Data&#39;)</span>

            <span class="c1"># Format the subplot</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> , MASE=</span><span class="si">{</span><span class="n">mase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Index&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="c1"># Apply x-tick rotation</span>
            <span class="c1"># axes[i].xaxis.set_major_locator(mdates.AutoDateLocator())</span>
            <span class="c1"># axes[i].xaxis.set_major_formatter(mdates.DateFormatter(&#39;%Y-%m-%d&#39;))</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="c1"># axes[i].xaxis.set_major_formatter(mdates.DateFormatter(&#39;%Y-%m-%d&#39;))</span>
            <span class="c1"># convert the x-labels to days every month</span>
            <span class="c1"># axes[i].xaxis.set_major_locator(plt.MaxNLocator(6))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Plot the original data</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">],</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">column_name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
        
        <span class="c1"># Calculate the 5th and 95th percentiles for the confidence interval</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">forecast_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Plot the forecast</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_index</span><span class="p">:],</span> <span class="n">forecast_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot the confidence intervals</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_index</span><span class="p">:],</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> 
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% CI&#39;</span><span class="p">)</span>


        <span class="c1"># set the x-axis labels as the number of days</span>
        <span class="c1"># axes[i].set_xticks(np.arange(0,len(df_wide[&#39;datetime&#39;]), step=30))</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

        <span class="c1"># Plot the evaluation data for reference</span>
        <span class="c1"># axes[i].plot(df_wide[&#39;datetime&#39;].iloc[split_index:], eval_data[column_name].values, &#39;--&#39;, label=&#39;Evaluation Data&#39;)</span>

        <span class="c1"># Format the subplot</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> , MASE=</span><span class="si">{</span><span class="n">mase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Index&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># Apply x-tick rotation</span>
        <span class="c1"># axes[i].xaxis.set_major_locator(mdates.AutoDateLocator())</span>
        <span class="c1"># axes[i].xaxis.set_major_formatter(mdates.DateFormatter(&#39;%Y-%m-%d&#39;))</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>




    <span class="c1"># Remove empty subplots if n_timeseries &lt; 8</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># also save a SVG </span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="s1">&#39;.svg&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># add a column to df_wide with the predictions for each target_{i} labels at the rows of the evaluation data</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns_to_forecast</span><span class="p">):</span>
        <span class="n">df_wide</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_wide</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_index</span><span class="p">:],</span> <span class="sa">f</span><span class="s1">&#39;forecast_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># store the new df_wide with the precition into a new CSV files that takes the filename of the original file</span>
    <span class="n">df_wide</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="s1">&#39;.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Quick plot</span>
<span class="k">def</span> <span class="nf">quick_plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quick plot of the time series data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df_wide (pd.DataFrame): The wide-format DataFrame containing the time series.</span>
<span class="sd">    n_timeseries (int): Number of time series to plot.</span>
<span class="sd">    field (str): The field to plot.</span>


<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the number of rows and columns for the subplots</span>
    <span class="n">n_timeseries2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># Cap the number of time series to 12</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_timeseries2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_timeseries2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># define the figure and subplots</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timeseries2</span><span class="p">):</span>
        <span class="c1"># create a time axis that multiplies time_data by dt</span>
        <span class="c1"># Calculate the time index as the difference from the first datetime</span>
        <span class="c1"># df_wide[&#39;time_index&#39;] = (df_wide[&#39;time_index&#39;] - df_wide[&#39;time_index&#39;].iloc[0]).dt.total_seconds() / (24 * 3600)</span>

        <span class="c1"># Convert the time_index to a float array</span>
        <span class="n">time_index_days_float</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;time_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>


      
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_index_days_float</span><span class="p">,</span> <span class="n">df_wide</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;target_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Days&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="earthquake-data">
<h3>5.1 Earthquake Data<a class="headerlink" href="#earthquake-data" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first we load data/data_qtm_catalog.csv</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/data_qtm_catalog.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>datetime</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-01-01</td>
      <td>120</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-01-02</td>
      <td>89</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-01-03</td>
      <td>146</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-01-04</td>
      <td>166</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-01-05</td>
      <td>94</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the time difference between each datetime to set up the dt</span>
<span class="c1"># convert the datetime column to datetime object</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># convert seconds to days</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<section id="reshape-for-prediction">
<h4>Reshape for Prediction<a class="headerlink" href="#reshape-for-prediction" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># randomly cut the long time series into n_timeseries, stored in data frames.</span>
<span class="n">df_list</span><span class="p">,</span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">reshape_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name_of_target</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sampling rate 1.00 days
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quick_plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;QTM count&quot;</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/mlgeo_4.10_timeseriesforecast_39_0.png" src="../_images/mlgeo_4.10_timeseriesforecast_39_0.png" />
</div>
</div>
</section>
<section id="predict-with-chronos-plot">
<h4>Predict with Chronos &amp; Plot<a class="headerlink" href="#predict-with-chronos-plot" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
<span class="c1"># plot forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;QTM event counts&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/quake_qtm_forecast.png&quot;</span><span class="p">)</span>
<span class="c1"># save a vectorized plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Absolute Error (MAE) for target_1: 48.48504137992859
Mean Absolute Error (MAE) for target_2: 50.47730255126953
Mean Absolute Error (MAE) for target_3: 73.13016510009766
Mean Absolute Error (MAE) for target_4: 29.68954849243164
Mean Absolute Error (MAE) for target_5: 65.26891136169434
Mean Absolute Error (MAE) for target_6: 68.76318144798279
Mean Absolute Error (MAE) for target_7: 35.08878254890442
Mean Absolute Error (MAE) for target_8: 57.32973098754883
Mean Absolute Error (MAE) for target_9: 45.120017528533936
Mean Absolute Error (MAE) for target_10: 53.568915605545044
Mean Absolute Error (MAE) for target_11: 37.61477780342102
Mean Absolute Error (MAE) for target_12: 110.07398819923401
Mean Absolute Error (MAE) for target_13: 39.093090534210205
Mean Absolute Error (MAE) for target_14: 80.03271508216858
Mean Absolute Error (MAE) for target_15: 67.37908172607422
Mean Absolute Error (MAE) for target_16: 43.82308888435364
Mean Absolute Error (MAE) for target_17: 192.06181573867798
Mean Absolute Error (MAE) for target_18: 32.19101405143738
Mean Absolute Error (MAE) for target_19: 41.79396343231201
Mean Absolute Error (MAE) for target_20: 69.41318273544312
Mean of forecast MAEs = 62.019915759563446
Mean Absolute Scaled Error (MASE) for target_1: 1.0329920889196824
Mean Absolute Scaled Error (MASE) for target_2: 0.7644399184447067
Mean Absolute Scaled Error (MASE) for target_3: 1.615994528693845
Mean Absolute Scaled Error (MASE) for target_4: 0.7835951215011284
Mean Absolute Scaled Error (MASE) for target_5: 0.9174344970519285
Mean Absolute Scaled Error (MASE) for target_6: 1.675205116482179
Mean Absolute Scaled Error (MASE) for target_7: 0.9149806707702726
Mean Absolute Scaled Error (MASE) for target_8: 1.3712122445769082
Mean Absolute Scaled Error (MASE) for target_9: 1.037809822671646
Mean Absolute Scaled Error (MASE) for target_10: 0.9770821317745623
Mean Absolute Scaled Error (MASE) for target_11: 0.9411163628338063
Mean Absolute Scaled Error (MASE) for target_12: 1.2275909464598587
Mean Absolute Scaled Error (MASE) for target_13: 0.7725422533422971
Mean Absolute Scaled Error (MASE) for target_14: 0.9836248634757355
Mean Absolute Scaled Error (MASE) for target_15: 1.2271992335191315
Mean Absolute Scaled Error (MASE) for target_16: 0.8978388942160257
Mean Absolute Scaled Error (MASE) for target_17: 1.1899974814650582
Mean Absolute Scaled Error (MASE) for target_18: 1.251872768667009
Mean Absolute Scaled Error (MASE) for target_19: 1.2067001357633624
Mean Absolute Scaled Error (MASE) for target_20: 1.5479754025957226
Mean of forecast MAEs = 1.1168602241612433
Mean of ARIMA MAEs = 97.278125
torch.Size([20, 9, 64])
torch.Size([20, 64])
Mean of forecast MASEs = 1.1049544541817105
12
</pre></div>
</div>
<img alt="../_images/mlgeo_4.10_timeseriesforecast_41_1.png" src="../_images/mlgeo_4.10_timeseriesforecast_41_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_wide</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_index</th>
      <th>target_1</th>
      <th>target_2</th>
      <th>target_3</th>
      <th>target_4</th>
      <th>target_5</th>
      <th>target_6</th>
      <th>target_7</th>
      <th>target_8</th>
      <th>target_9</th>
      <th>...</th>
      <th>forecast_2</th>
      <th>forecast_3</th>
      <th>forecast_4</th>
      <th>forecast_5</th>
      <th>forecast_6</th>
      <th>forecast_7</th>
      <th>forecast_8</th>
      <th>forecast_9</th>
      <th>forecast_10</th>
      <th>forecast_11</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>193</td>
      <td>191.0</td>
      <td>149.0</td>
      <td>216.0</td>
      <td>185.0</td>
      <td>168.0</td>
      <td>223.0</td>
      <td>220.0</td>
      <td>175.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>212</td>
      <td>180.0</td>
      <td>220.0</td>
      <td>173.0</td>
      <td>176.0</td>
      <td>190.0</td>
      <td>188.0</td>
      <td>246.0</td>
      <td>150.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>250</td>
      <td>183.0</td>
      <td>220.0</td>
      <td>218.0</td>
      <td>142.0</td>
      <td>171.0</td>
      <td>368.0</td>
      <td>205.0</td>
      <td>181.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>312</td>
      <td>155.0</td>
      <td>123.0</td>
      <td>199.0</td>
      <td>172.0</td>
      <td>173.0</td>
      <td>588.0</td>
      <td>159.0</td>
      <td>176.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>242</td>
      <td>184.0</td>
      <td>163.0</td>
      <td>177.0</td>
      <td>146.0</td>
      <td>128.0</td>
      <td>202.0</td>
      <td>153.0</td>
      <td>207.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 33 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install statsmodels
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.arima.model</span> <span class="kn">import</span> <span class="n">ARIMA</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: statsmodels in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (0.14.2)
Requirement already satisfied: numpy&gt;=1.22.3 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from statsmodels) (1.26.4)
Requirement already satisfied: scipy!=1.9.2,&gt;=1.8 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from statsmodels) (1.11.4)
Requirement already satisfied: pandas!=2.1.0,&gt;=1.4 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from statsmodels) (2.1.4)
Requirement already satisfied: patsy&gt;=0.5.6 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from statsmodels) (0.5.6)
Requirement already satisfied: packaging&gt;=21.3 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from statsmodels) (24.1)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2.9.0.post0)
Requirement already satisfied: pytz&gt;=2020.1 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2024.1)
Requirement already satisfied: tzdata&gt;=2022.1 in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2024.1)
Requirement already satisfied: six in /home/mdenolle/miniconda/envs/quake_chronos_moirai/lib/python3.11/site-packages (from patsy&gt;=0.5.6-&gt;statsmodels) (1.16.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># benchmarking with ARIMA</span>
<span class="c1"># Fit ARIMA model</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_4&#39;</span><span class="p">][:</span><span class="n">split_index</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># (p, d, q) order, adjust as needed</span>
<span class="n">model_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">forecast_steps</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># Number of steps to forecast</span>
<span class="n">forecast</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">forecast_steps</span><span class="p">)</span>

<span class="n">split_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span>
<span class="nb">print</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span> 
<span class="c1"># calculate the MASE between the forecast and the evaluation data</span>
<span class="n">mase</span><span class="o">=</span><span class="p">[]</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">][</span><span class="n">split_index</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]))</span>
<span class="c1"># Calculate and print the MASE for each time series</span>
<span class="n">mase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast</span> <span class="o">-</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
<span class="c1"># print mase</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Absolute Scaled Error (MASE) for ARIMA: </span><span class="si">{</span><span class="n">mase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                 

<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>667    170.875002
668    109.156006
669    134.097091
670    115.263988
671    123.108176
          ...    
726    -36.171929
727    -35.465038
728    -41.488969
729    -41.760654
730    -47.384863
Name: predicted_mean, Length: 64, dtype: float64
64
Mean Absolute Scaled Error (MASE) for ARIMA: 4.420838227473031
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7fdd04707e90&gt;]
</pre></div>
</div>
<img alt="../_images/mlgeo_4.10_timeseriesforecast_44_2.png" src="../_images/mlgeo_4.10_timeseriesforecast_44_2.png" />
</div>
</div>
</section>
</section>
<section id="icesheet-velocities">
<h3>5.2 Icesheet velocities<a class="headerlink" href="#icesheet-velocities" title="Permalink to this headline">#</a></h3>
<p>Now we test the time series of icesheet velocities in Greenland. This is work done by Brad Lipovsky.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Read the data</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/data_ice_jakobshavn.csv&#39;</span><span class="p">,</span><span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the time difference between each datetime to set up the dt</span>
<span class="c1"># convert the datetime column to datetime object</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># convert seconds to days</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sampling rate </span><span class="si">{}</span><span class="s2"> days&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sampling rate 8.0 days
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h4>Reshape for prediction<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">df</span>
<span class="n">df_wide</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Pixel Value (x=2500, y=8200)</th>
      <th>Pixel Value (x=2500, y=8201)</th>
      <th>Pixel Value (x=2500, y=8202)</th>
      <th>Pixel Value (x=2500, y=8203)</th>
      <th>Pixel Value (x=2500, y=8204)</th>
      <th>Pixel Value (x=2500, y=8205)</th>
      <th>Pixel Value (x=2500, y=8206)</th>
      <th>Pixel Value (x=2500, y=8207)</th>
      <th>Pixel Value (x=2500, y=8208)</th>
      <th>...</th>
      <th>Pixel Value (x=2509, y=8201)</th>
      <th>Pixel Value (x=2509, y=8202)</th>
      <th>Pixel Value (x=2509, y=8203)</th>
      <th>Pixel Value (x=2509, y=8204)</th>
      <th>Pixel Value (x=2509, y=8205)</th>
      <th>Pixel Value (x=2509, y=8206)</th>
      <th>Pixel Value (x=2509, y=8207)</th>
      <th>Pixel Value (x=2509, y=8208)</th>
      <th>Pixel Value (x=2509, y=8209)</th>
      <th>datetime</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2015-01-01</td>
      <td>2690.5570</td>
      <td>2682.3616</td>
      <td>2658.6174</td>
      <td>2606.9355</td>
      <td>2530.3400</td>
      <td>2432.4604</td>
      <td>2337.5603</td>
      <td>2238.3130</td>
      <td>2131.6187</td>
      <td>...</td>
      <td>1860.1473</td>
      <td>1811.2555</td>
      <td>1772.2811</td>
      <td>1739.5938</td>
      <td>1691.1827</td>
      <td>1651.6400</td>
      <td>1610.4110</td>
      <td>1563.1417</td>
      <td>1513.4183</td>
      <td>2015-01-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2015-01-13</td>
      <td>2714.7678</td>
      <td>2694.3774</td>
      <td>2657.5322</td>
      <td>2604.6094</td>
      <td>2541.0916</td>
      <td>2492.7390</td>
      <td>2451.3862</td>
      <td>2415.7693</td>
      <td>2235.5337</td>
      <td>...</td>
      <td>1866.2997</td>
      <td>1801.4703</td>
      <td>1747.1519</td>
      <td>1679.1748</td>
      <td>1619.7880</td>
      <td>1580.2765</td>
      <td>1548.2367</td>
      <td>1506.4203</td>
      <td>1471.4894</td>
      <td>2015-01-13</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2015-01-25</td>
      <td>2712.4210</td>
      <td>2724.5880</td>
      <td>2735.8308</td>
      <td>2645.3513</td>
      <td>2518.3074</td>
      <td>2460.4731</td>
      <td>2262.7056</td>
      <td>2141.2844</td>
      <td>2034.8848</td>
      <td>...</td>
      <td>1807.4071</td>
      <td>1738.1703</td>
      <td>1679.8862</td>
      <td>1627.8777</td>
      <td>1575.1526</td>
      <td>1554.8282</td>
      <td>1534.6147</td>
      <td>1520.7195</td>
      <td>1515.0082</td>
      <td>2015-01-25</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2015-02-18</td>
      <td>2641.4170</td>
      <td>2613.6772</td>
      <td>2577.1538</td>
      <td>2528.2330</td>
      <td>2444.6372</td>
      <td>2356.7375</td>
      <td>2280.1716</td>
      <td>2216.3354</td>
      <td>2187.7751</td>
      <td>...</td>
      <td>1803.6461</td>
      <td>1748.5105</td>
      <td>1696.6669</td>
      <td>1643.1813</td>
      <td>1591.3317</td>
      <td>1547.9862</td>
      <td>1504.9419</td>
      <td>1459.6843</td>
      <td>1411.1000</td>
      <td>2015-02-18</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2015-03-02</td>
      <td>2695.7231</td>
      <td>2654.4783</td>
      <td>2596.1223</td>
      <td>2527.4956</td>
      <td>2450.6010</td>
      <td>2383.8125</td>
      <td>2317.7700</td>
      <td>2231.7078</td>
      <td>2069.8728</td>
      <td>...</td>
      <td>1768.4241</td>
      <td>1721.1057</td>
      <td>1695.4995</td>
      <td>1661.2021</td>
      <td>1618.2247</td>
      <td>1578.6671</td>
      <td>1531.1387</td>
      <td>1487.0217</td>
      <td>1451.7004</td>
      <td>2015-03-02</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>437</th>
      <td>2024-02-25</td>
      <td>2355.7673</td>
      <td>2317.1812</td>
      <td>2267.6526</td>
      <td>2218.5762</td>
      <td>2174.4893</td>
      <td>2119.7183</td>
      <td>2036.1709</td>
      <td>1886.2402</td>
      <td>1742.2327</td>
      <td>...</td>
      <td>1555.8588</td>
      <td>1496.1707</td>
      <td>1448.4729</td>
      <td>1410.3757</td>
      <td>1372.7169</td>
      <td>1332.9342</td>
      <td>1291.7050</td>
      <td>1252.8741</td>
      <td>1215.6035</td>
      <td>2024-02-25</td>
    </tr>
    <tr>
      <th>438</th>
      <td>2024-03-08</td>
      <td>2356.8071</td>
      <td>2318.0103</td>
      <td>2271.4500</td>
      <td>2208.3280</td>
      <td>2131.2380</td>
      <td>2038.9028</td>
      <td>1941.8640</td>
      <td>1839.1848</td>
      <td>1730.7375</td>
      <td>...</td>
      <td>1584.8710</td>
      <td>1545.4580</td>
      <td>1487.4086</td>
      <td>1430.3809</td>
      <td>1381.1884</td>
      <td>1338.1537</td>
      <td>1301.4970</td>
      <td>1264.5914</td>
      <td>1226.1100</td>
      <td>2024-03-08</td>
    </tr>
    <tr>
      <th>439</th>
      <td>2024-03-20</td>
      <td>2369.9165</td>
      <td>2318.2954</td>
      <td>2239.7700</td>
      <td>2166.4363</td>
      <td>2106.1460</td>
      <td>2046.7198</td>
      <td>1997.2346</td>
      <td>1934.0216</td>
      <td>1812.1205</td>
      <td>...</td>
      <td>1542.8604</td>
      <td>1510.4088</td>
      <td>1461.9852</td>
      <td>1407.3877</td>
      <td>1358.6483</td>
      <td>1318.0781</td>
      <td>1282.2297</td>
      <td>1241.4624</td>
      <td>1196.6234</td>
      <td>2024-03-20</td>
    </tr>
    <tr>
      <th>440</th>
      <td>2024-04-01</td>
      <td>2304.3186</td>
      <td>2255.6506</td>
      <td>2209.5908</td>
      <td>2154.6484</td>
      <td>2079.5513</td>
      <td>1998.6061</td>
      <td>1931.5712</td>
      <td>1849.2580</td>
      <td>1743.1146</td>
      <td>...</td>
      <td>1568.9454</td>
      <td>1520.7106</td>
      <td>1462.4568</td>
      <td>1407.1897</td>
      <td>1359.1794</td>
      <td>1317.0726</td>
      <td>1278.7156</td>
      <td>1242.9205</td>
      <td>1201.6306</td>
      <td>2024-04-01</td>
    </tr>
    <tr>
      <th>441</th>
      <td>2024-04-13</td>
      <td>2300.0273</td>
      <td>2244.5710</td>
      <td>2165.4233</td>
      <td>2103.4187</td>
      <td>2059.3809</td>
      <td>1990.8022</td>
      <td>1887.8052</td>
      <td>1750.1135</td>
      <td>1652.9683</td>
      <td>...</td>
      <td>1529.3740</td>
      <td>1496.3535</td>
      <td>1455.9960</td>
      <td>1412.7965</td>
      <td>1370.8213</td>
      <td>1326.9905</td>
      <td>1279.7404</td>
      <td>1225.2361</td>
      <td>1173.2060</td>
      <td>2024-04-13</td>
    </tr>
  </tbody>
</table>
<p>418 rows × 102 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove the first column and place the last at first position</span>
<span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now rename all Pixel columns to indexes except for the first one</span>
<span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time_index&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;target_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quick_plot</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;Glacier Vel&quot;</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/mlgeo_4.10_timeseriesforecast_52_0.png" src="../_images/mlgeo_4.10_timeseriesforecast_52_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">notebook</span> <span class="n">controller</span> <span class="ow">is</span> <span class="n">DISPOSED</span><span class="o">.</span> 

<span class="n">View</span> <span class="n">Jupyter</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;command:jupyter.viewOutput&#39;</span><span class="o">&gt;</span><span class="n">log</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">further</span> <span class="n">details</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_predict</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">time_forecast</span> <span class="o">=</span> <span class="n">n_predict</span> <span class="o">*</span> <span class="n">dt</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forecasting for </span><span class="si">{}</span><span class="s2"> days&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_forecast</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Forecasting for 40.0 days
</pre></div>
</div>
</div>
</div>
</section>
<section id="predict-plot-forecasts-with-chronos">
<h4>Predict &amp; Plot forecasts with Chronos<a class="headerlink" href="#predict-plot-forecasts-with-chronos" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">predict_length</span><span class="o">=</span><span class="n">n_predict</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
<span class="c1"># plot</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;Velocity (m/a)&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/ice_jakobshavn_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Absolute Error (MAE) for target_0: 42.24474937499999
Mean Absolute Error (MAE) for target_1: 51.846288281250054
Mean Absolute Error (MAE) for target_2: 63.66113656250009
Mean Absolute Error (MAE) for target_3: 68.27394875
Mean Absolute Error (MAE) for target_4: 59.332813359374995
Mean Absolute Error (MAE) for target_5: 54.84119093749996
Mean Absolute Error (MAE) for target_6: 51.02073972656249
Mean Absolute Error (MAE) for target_7: 56.604517070312525
Mean Absolute Error (MAE) for target_8: 60.905154804687484
Mean Absolute Error (MAE) for target_9: 46.845470039062505
Mean Absolute Error (MAE) for target_10: 45.993564921874984
Mean Absolute Error (MAE) for target_11: 51.39334015625
Mean Absolute Error (MAE) for target_12: 63.96544187500003
Mean Absolute Error (MAE) for target_13: 71.486827890625
Mean Absolute Error (MAE) for target_14: 67.60769390625
Mean Absolute Error (MAE) for target_15: 68.74598835937499
Mean Absolute Error (MAE) for target_16: 62.17083863281255
Mean Absolute Error (MAE) for target_17: 65.56442820312505
Mean Absolute Error (MAE) for target_18: 66.02327011718754
Mean Absolute Error (MAE) for target_19: 64.03354175781246
Mean of forecast MAEs = 59.12804723632813
Mean Absolute Scaled Error (MASE) for target_0: 2.010735538753725
Mean Absolute Scaled Error (MASE) for target_1: 2.7710987795736437
Mean Absolute Scaled Error (MASE) for target_2: 2.3186581656485306
Mean Absolute Scaled Error (MASE) for target_3: 2.3714981221370772
Mean Absolute Scaled Error (MASE) for target_4: 2.0618065531055927
Mean Absolute Scaled Error (MASE) for target_5: 1.5175690902323826
Mean Absolute Scaled Error (MASE) for target_6: 0.7876400007342528
Mean Absolute Scaled Error (MASE) for target_7: 0.6949596678740014
Mean Absolute Scaled Error (MASE) for target_8: 0.966631879403238
Mean Absolute Scaled Error (MASE) for target_9: 1.3144366326702754
Mean Absolute Scaled Error (MASE) for target_10: 1.0350373126193724
Mean Absolute Scaled Error (MASE) for target_11: 1.7442638916464657
Mean Absolute Scaled Error (MASE) for target_12: 3.2202381431841833
Mean Absolute Scaled Error (MASE) for target_13: 2.6931039274055864
Mean Absolute Scaled Error (MASE) for target_14: 2.29931356317334
Mean Absolute Scaled Error (MASE) for target_15: 2.0899756897892243
Mean Absolute Scaled Error (MASE) for target_16: 1.4075847948663025
Mean Absolute Scaled Error (MASE) for target_17: 1.3198358208382497
Mean Absolute Scaled Error (MASE) for target_18: 1.4886333326686638
Mean Absolute Scaled Error (MASE) for target_19: 2.2221349867240554
Mean of forecast MAEs = 1.8167577946524083
Mean of ARIMA MAEs = 55.618072
torch.Size([20, 9, 5])
torch.Size([20, 5])
Mean of forecast MASEs = 1.6328613028665464
12
</pre></div>
</div>
<img alt="../_images/mlgeo_4.10_timeseriesforecast_56_1.png" src="../_images/mlgeo_4.10_timeseriesforecast_56_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># benchmarking with ARIMA</span>
<span class="c1"># Fit ARIMA model</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_3&#39;</span><span class="p">][:</span><span class="n">split_index</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># (p, d, q) order, adjust as needed</span>
<span class="n">model_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">forecast_steps</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># Number of steps to forecast</span>
<span class="n">forecast</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">forecast_steps</span><span class="p">)</span>

<span class="n">split_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span>
<span class="nb">print</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span> 
<span class="c1"># calculate the MASE between the forecast and the evaluation data</span>
<span class="n">mase</span><span class="o">=</span><span class="p">[]</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">][</span><span class="n">split_index</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]))</span>
<span class="c1"># Calculate and print the MASE for each time series</span>
<span class="n">mase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast</span> <span class="o">-</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">df_wide</span><span class="p">[</span><span class="s1">&#39;target_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
<span class="c1"># print mase</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Absolute Scaled Error (MASE) for ARIMA: </span><span class="si">{</span><span class="n">mase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                 

<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="forecasting-gps-velocities">
<h3>5.3 Forecasting GPS velocities<a class="headerlink" href="#forecasting-gps-velocities" title="Permalink to this headline">#</a></h3>
<p>In this case, we are going to test Chrono’s performance on GPS time series. Vertical components tend to exhibit seasonal loading from precipitation, horizontal components tend to exhibit tectonic processes, especially at plate boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read data from data_gps_P395_relateive_position.csv</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;../data/data_gps_P395_relative_position.csv&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="c1"># convert dacimal year column to floats</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;decimal year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;decimal year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="c1"># the date format is in decimal years, convert it to datetime</span>
<span class="c1"># df[&quot;datetime&quot;] = pd.to_datetime(df[&quot;decimal year&quot;], format=&quot;%Y.%j&quot;)</span>
<span class="c1"># df.head()</span>


<span class="c1"># perform a running mean average to smooth the data</span>
<span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sta_name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sta_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># take the first column &quot;decimal year&quot; and convert it to a datetime by taking the year before the comma, then multuply by 365.25 to get the days</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;decimal year&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1970</span><span class="p">)</span> <span class="o">*</span> <span class="mf">365.25</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;1970-01-01&#39;</span><span class="p">)</span>
<span class="c1"># move the last to the first position</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_list</span><span class="p">,</span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">reshape_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">name_of_target</span><span class="o">=</span><span class="s2">&quot;new delta v (m)&quot;</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># now predict with chronos</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
<span class="c1"># plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;GPS relative position (m)&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/gps_&quot;</span><span class="o">+</span><span class="n">sta_name</span><span class="o">+</span><span class="s2">&quot;_v_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="horizontal-components">
<h4>Horizontal components<a class="headerlink" href="#horizontal-components" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_list</span><span class="p">,</span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">reshape_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">name_of_target</span><span class="o">=</span><span class="s2">&quot;new delta e (m)&quot;</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># now predict with chronos</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
<span class="c1"># plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;GPS relative position (m)&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/gps_&quot;</span><span class="o">+</span><span class="n">sta_name</span><span class="o">+</span><span class="s2">&quot;_e_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="forecast-dv-v">
<h3>5.4 Forecast dv/v<a class="headerlink" href="#forecast-dv-v" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read one dv/v file</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;../data/DVV_data_withMean/Data_BGU.csv&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">sta_name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the date into a timestamp</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="c1"># move datetime to the first position</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="soil-moisture">
<h3>5.5 Soil moisture<a class="headerlink" href="#soil-moisture" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_list</span><span class="p">,</span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">reshape_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">name_of_target</span><span class="o">=</span><span class="s2">&quot;sm_ewt&quot;</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># now predict with chronos</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
<span class="c1"># plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;Soil Moisture&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/&quot;</span><span class="o">+</span><span class="n">sta_name</span><span class="o">+</span><span class="s2">&quot;_SM_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]:</span>
    <span class="k">if</span> <span class="n">ikey</span> <span class="o">==</span> <span class="s2">&quot;lake&quot;</span><span class="p">:</span>
        <span class="c1"># remove mean of the column</span>
        <span class="n">df</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df_list</span><span class="p">,</span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">reshape_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">name_of_target</span><span class="o">=</span><span class="n">ikey</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1"># now predict with chronos</span>
    <span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
    <span class="c1"># plot the forecast</span>
    <span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="n">ikey</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/&quot;</span><span class="o">+</span><span class="n">sta_name</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">ikey</span><span class="o">+</span><span class="s2">&quot;_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="seismic-wave">
<h4>5.6 Seismic Wave<a class="headerlink" href="#seismic-wave" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read CSV file with waveforms in them</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/data_waveforms.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># trim data between 100 and 200 rows</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">300</span><span class="p">:</span><span class="mi">500</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#make a datetime column</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_wide</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">df</span>
<span class="c1"># rename the keys from Z, N, E, to target_0, target_1, target_2</span>
<span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;target_0&quot;</span><span class="p">,</span><span class="s2">&quot;target_1&quot;</span><span class="p">,</span><span class="s2">&quot;target_2&quot;</span><span class="p">,</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>

<span class="c1"># reset df_wide index:</span>
<span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># create a time_index column that is the index of the time series</span>
<span class="n">df_wide</span><span class="p">[</span><span class="s2">&quot;time_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wide</span><span class="p">))</span>

<span class="c1"># move datetime to the first position</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

<span class="c1"># drop columns time and datetime</span>
<span class="n">df_wide</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

<span class="c1"># # now predict with chronos</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">predict_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># # plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;wave&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/waveforms_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># normalize the target data in df_wide to see if this is the problem</span>

<span class="n">df_wide_norm</span> <span class="o">=</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">df_wide</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ikey</span> <span class="o">!=</span> <span class="s2">&quot;time_index&quot;</span><span class="p">:</span>
        <span class="n">df_wide_norm</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_wide</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df_wide</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>


<span class="c1"># # now predict with chronos</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide_norm</span><span class="p">,</span><span class="n">predict_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># # plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide_norm</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;wave&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/waveforms_forecast_norm.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="co2">
<h4>5.7 CO2<a class="headerlink" href="#co2" title="Permalink to this headline">#</a></h4>
<p>Here we plan to forecast CO2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;../data/cleaned_data_co2.csv&quot;</span>
<span class="n">df_co2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>


<span class="c1"># Function to convert decimal year to datetime</span>
<span class="k">def</span> <span class="nf">decimal_year_to_datetime</span><span class="p">(</span><span class="n">decimal_year</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">decimal_year</span><span class="p">)</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">decimal_year</span> <span class="o">-</span> <span class="n">year</span>
    <span class="n">start_of_year</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">days_in_year</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_of_year</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
    <span class="k">return</span> <span class="n">start_of_year</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">remainder</span> <span class="o">*</span> <span class="n">days_in_year</span><span class="p">)</span>

<span class="c1"># Apply the function to the &#39;decimale-date&#39; column</span>
<span class="n">df_co2</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_co2</span><span class="p">[</span><span class="s2">&quot;decimale-date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">decimal_year_to_datetime</span><span class="p">)</span>


<span class="c1"># df_co2[&quot;datetime&quot;] = pd.to_datetime((df_co2[&quot;decimale-date&quot;] - 1970) * 365.25, origin=&#39;1970-01-01&#39;, unit=&#39;D&#39;)</span>
<span class="n">df_co2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="c1"># # move datetime to the first position</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">df_co2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_co2</span> <span class="o">=</span> <span class="n">df_co2</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">df_co2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_list</span><span class="p">,</span><span class="n">df_wide</span> <span class="o">=</span> <span class="n">reshape_time_series</span><span class="p">(</span><span class="n">df_co2</span><span class="p">,</span><span class="n">name_of_target</span><span class="o">=</span><span class="s2">&quot;monthly-average&quot;</span><span class="p">,</span> <span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">,</span> <span class="n">duration_years</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1"># now predict with chronos</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="n">n_timeseries</span><span class="p">)</span>
<span class="c1"># plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="n">n_timeseries</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;C02 Moana&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/CO2_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="paleo-climate-benthic-d018-time-series">
<h4>5.8 Paleo Climate Benthic D018 time series<a class="headerlink" href="#paleo-climate-benthic-d018-time-series" title="Permalink to this headline">#</a></h4>
<p>This time series is phenomenal because it shows how the system switches from 100ka cycle to 20-40ka cycles. <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2004PA001071">https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2004PA001071</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_benthic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/cleaned_lr04.csv&quot;</span><span class="p">)</span>
<span class="n">df_benthic</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_benthic</span><span class="p">[</span><span class="s2">&quot;Time-(ka)&quot;</span><span class="p">],</span><span class="n">df_benthic</span><span class="p">[</span><span class="s2">&quot;Benthic-d18O-(per-mil)&quot;</span><span class="p">])</span>   
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ka)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Benthic d18O (per mil)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Benthic d18O vs Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add a time_index column to the dataframe</span>
<span class="n">df_benthic</span><span class="p">[</span><span class="s2">&quot;time_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_benthic</span><span class="p">))</span>
<span class="c1"># remove Time-(ka) column</span>
<span class="n">df_benthic</span> <span class="o">=</span> <span class="n">df_benthic</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Time-(ka)&quot;</span><span class="p">])</span>
<span class="c1"># move the last to the first position</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">df_benthic</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_benthic</span> <span class="o">=</span> <span class="n">df_benthic</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">df_benthic</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_benthic_copy</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now predict with chronos</span>
<span class="n">df_benthic_copy</span> <span class="o">=</span> <span class="n">df_benthic</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df_benthic</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">]</span>
<span class="c1"># rename benthic-d18O-(per-mil) to target_1</span>
<span class="n">df_benthic_copy</span> <span class="o">=</span> <span class="n">df_benthic_copy</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Benthic-d18O-(per-mil)&quot;</span><span class="p">:</span><span class="s2">&quot;target_1&quot;</span><span class="p">})</span>
<span class="n">forecast</span><span class="p">,</span> <span class="n">mean_mae</span><span class="p">,</span> <span class="n">mean_mase</span><span class="p">,</span> <span class="n">no_var_mae</span><span class="p">,</span> <span class="n">split_index</span> <span class="o">=</span> <span class="n">predict_chronos</span><span class="p">(</span><span class="n">df_benthic_copy</span><span class="p">,</span><span class="n">predict_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span><span class="n">n_timeseries</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># plot the forecast</span>
<span class="n">plot_forecasts</span><span class="p">(</span><span class="n">df_benthic_copy</span><span class="p">,</span><span class="n">split_index</span><span class="p">,</span><span class="n">forecast</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;D018&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./plots/d018_forecast.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter4-DeepLearning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="mlgeo_4.9_LLM4Geo.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">4.9 LLMGEO</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="mlgeo_4.20_final_project_assignement.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><strong>Deep Learning Exploration with AI-Ready Datasets</strong></p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By eScience Institute, University of Washington<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>